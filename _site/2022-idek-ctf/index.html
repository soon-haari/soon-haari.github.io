<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>2022 Idek Ctf</title><!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v3.9.4" />
<meta property="og:title" content="2022 Idek Ctf" />
<meta name="author" content="김민순" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Wonder Why" />
<meta property="og:description" content="Wonder Why" />
<link rel="canonical" href="http://localhost:4000/2022-idek-ctf/" />
<meta property="og:url" content="http://localhost:4000/2022-idek-ctf/" />
<meta property="og:site_name" content="I’m such a good surfer" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-01-17T00:00:00+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="2022 Idek Ctf" />
<script type="application/ld+json">
{"description":"Wonder Why","url":"http://localhost:4000/2022-idek-ctf/","@type":"BlogPosting","headline":"2022 Idek Ctf","dateModified":"2023-01-17T00:00:00+09:00","datePublished":"2023-01-17T00:00:00+09:00","author":{"@type":"Person","name":"김민순"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2022-idek-ctf/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="I&apos;m such a good surfer" /><script type="text/x-mathjax-config">
MathJax.Hub.Config({
    TeX: {
      equationNumbers: {
        autoNumber: "AMS"
      }
    },
    tex2jax: {
    inlineMath: [ ['$', '$'] ],
    displayMath: [ ['$$', '$$'] ],
    processEscapes: true,
  }
});
MathJax.Hub.Register.MessageHook("Math Processing Error",function (message) {
	  alert("Math Processing Error: "+message[1]);
	});
MathJax.Hub.Register.MessageHook("TeX Jax - parse error",function (message) {
	  alert("Math Processing Error: "+message[1]);
	});
</script>


<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

  <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
  <link rel="stylesheet" href="/assets/css/main.css" />
</head>
<body a="dark">
    <main class="page-content" aria-label="Content">
      <div class="w">
        <a href="/">cd ..</a><article>
  <p class="post-meta">
    <font size="2em">soon_haari</font>
    <time datetime="2023-01-17 00:00:00 +0900">2023-01-17</time>
  </p>
  
  <h1>2022 Idek Ctf</h1>

  <p><br /><br /></p>

<p>I ran idekCTF as team ‘thehackerscrew’.</p>

<p>I was surprised that ‘thehackerscrew’ contacted me through Discord, and asking me to join their team.</p>

<p>It was an honor running as a top team, and meeting other fantastic people in our team.</p>

<p>As a Crypto fanatic, I solved 4 crypto Challenges.</p>

<p><br /><br /></p>

<h2 id="ecrsa-40-solves">ECRSA (40 solves)</h2>

<h3 id="mainsage">main.sage</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">p</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="p">[</span><span class="n">random_prime</span><span class="p">(</span><span class="mi">2</span><span class="o">^</span><span class="mi">512</span><span class="p">,</span> <span class="n">lbound</span> <span class="o">=</span> <span class="mi">2</span><span class="o">^</span><span class="mi">511</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
<span class="n">e</span> <span class="o">=</span> <span class="mi">3</span>

<span class="k">while</span> <span class="n">gcd</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="n">p</span> <span class="o">=</span> <span class="n">next_prime</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="k">while</span> <span class="n">gcd</span><span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="n">q</span> <span class="o">=</span> <span class="n">next_prime</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

<span class="n">n</span> <span class="o">=</span> <span class="n">p</span><span class="o">*</span><span class="n">q</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">inverse_mod</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

<span class="c1"># d stands for debug. You don't even know n, so I don't risk anything.
</span><span class="k">print</span><span class="p">(</span><span class="s">'d ='</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">ZZ</span><span class="p">(</span><span class="nb">int</span><span class="p">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="sa">b</span><span class="s">"It is UNBREAKABLE, I tell you!! I'll even bet a flag on it, here it is: idek{REDACTED}"</span><span class="p">,</span> <span class="s">'big'</span><span class="p">))</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">ZZ</span><span class="p">(</span><span class="nb">int</span><span class="p">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="sa">b</span><span class="s">"ECRSA offers added security by elliptic entropy."</span><span class="p">,</span> <span class="s">'big'</span><span class="p">))</span>
<span class="n">ym</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<span class="n">yt</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1"># I like it when my points lie on my curve.
</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">([[</span><span class="n">m</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]).</span><span class="n">solve_right</span><span class="p">([</span><span class="n">ym</span><span class="o">^</span><span class="mi">2</span> <span class="o">-</span> <span class="n">m</span><span class="o">^</span><span class="mi">3</span><span class="p">,</span> <span class="n">yt</span><span class="o">^</span><span class="mi">2</span> <span class="o">-</span> <span class="n">t</span><span class="o">^</span><span class="mi">3</span><span class="p">])</span>
<span class="n">E</span> <span class="o">=</span> <span class="n">EllipticCurve</span><span class="p">(</span><span class="n">Zmod</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">ym</span><span class="p">)</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">yt</span><span class="p">)</span>

<span class="n">E</span><span class="p">.</span><span class="n">base_field</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">base_ring</span> <span class="c1"># fix multiplication over rings (might not work depending on sage version!)
</span><span class="k">print</span><span class="p">(</span><span class="s">'Encrypted flag:'</span><span class="p">,</span> <span class="n">M</span><span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Encrypted test:'</span><span class="p">,</span> <span class="n">T</span><span class="o">*</span><span class="n">e</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<p>First of all, We don’t know the value for n, so we have to recover it with informations we know..</p>

<p>There is 3 points we know, enc_flag, enc_test, t</p>

<p>So theoretically we can recover all 3 unknown values: n, a, b</p>

<p><br /></p>

<p>But when we try to remove a, b, and get a multiple of n, we only find a very large multiple of n.</p>

<p>Gladly, we know t * 3 is enc_test on the elliptic curve.</p>

<p>Since we don’t know the value for a yet, we can add t, t, t and compare with enc_test.</p>

<p><br /></p>

<p>But point addition(or subtraction) doesn’t need the value for a, just 2 points and n.</p>

<p>So we can think:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(enc_test - t) - t == t (mod n)
</code></pre></div></div>

<p>After that, obviously the x value for the left point and the right point should be eqaul mod n.</p>

<p><br /></p>

<p>If we subtract one from one another, we get another multiple of n.</p>

<p>Calculating gcd with 2 multiples of n will easily give us n, which is:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>148789535372424163728266646450060056789282887632409478972504939920226619164297864570138212065846604310648872389662317508759494232616904707691022520428483000923260778669946008689451863137527523684502948570798504215922534787506491833325381174139925947167122783344470619692746866285435276907642606269209931602317
</code></pre></div></div>

<p><br /></p>

<p>Recovering a and b is easy now.</p>

<p>After that, we have to recover flag from enc_flag(flag * 3) with elliptic curve calculation.</p>

<p>If we know the order for the curve, we can find inverse of 3 mod order, and get the flag point.</p>

<p>But we can see it is impossible because n is composite, so we’ll have to factor n to p, q.</p>

<p><br /></p>

<p>Gladly, the challenge gave us d value, and since e is 3</p>

<p>3 * d should be phi(n) + 1 or 2 * phi(n) + 1. It turns out second one is correct.</p>

<p>We make 2 elliptic curves mod p and q, and find order for both.</p>

<p>(It took more time than I thought, I first thought I was missing something.)</p>

<p>With CRT, we can get the flag point mod n, and get the flag.</p>

<p><br /></p>

<h3 id="exsage">ex.sage</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">d</span> <span class="o">=</span> <span class="mf">99193.</span><span class="p">..</span><span class="mi">8587</span>
<span class="n">enc_flag</span> <span class="o">=</span> <span class="p">(</span><span class="mf">11507.</span><span class="p">..</span><span class="mi">8789</span><span class="p">,</span> <span class="mf">74232.</span><span class="p">..</span><span class="mi">2318</span><span class="p">)</span>
<span class="n">enc_test</span> <span class="o">=</span> <span class="p">(</span><span class="mf">79615.</span><span class="p">..</span><span class="mi">4937</span><span class="p">,</span> <span class="mf">11457.</span><span class="p">..</span><span class="mi">0982</span><span class="p">)</span>

<span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">ZZ</span><span class="p">(</span><span class="nb">int</span><span class="p">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="sa">b</span><span class="s">"ECRSA offers added security by elliptic entropy."</span><span class="p">,</span> <span class="s">'big'</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="n">enc_test</span><span class="p">,</span> <span class="n">enc_flag</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">point_to_eq</span><span class="p">(</span><span class="n">P</span><span class="p">):</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">P</span>

    <span class="n">a_coefficient</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">b_coefficient</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">constant</span> <span class="o">=</span> <span class="n">x</span><span class="o">^</span><span class="mi">3</span> <span class="o">-</span> <span class="n">y</span><span class="o">^</span><span class="mi">2</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">a_coefficient</span><span class="p">,</span> <span class="n">b_coefficient</span><span class="p">,</span> <span class="n">constant</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">kill_b</span><span class="p">(</span><span class="n">eq1</span><span class="p">,</span> <span class="n">eq2</span><span class="p">):</span>
    <span class="n">a1</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">c1</span> <span class="o">=</span> <span class="n">eq1</span>
    <span class="n">a2</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">c2</span> <span class="o">=</span> <span class="n">eq2</span>

    <span class="n">a_coefficient</span> <span class="o">=</span> <span class="n">a1</span> <span class="o">*</span> <span class="n">b2</span> <span class="o">-</span> <span class="n">a2</span> <span class="o">*</span> <span class="n">b1</span>
    <span class="n">constant</span> <span class="o">=</span> <span class="n">c1</span> <span class="o">*</span> <span class="n">b2</span> <span class="o">-</span> <span class="n">c2</span> <span class="o">*</span> <span class="n">b1</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">a_coefficient</span><span class="p">,</span> <span class="n">constant</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">kill_a</span><span class="p">(</span><span class="n">eq1</span><span class="p">,</span> <span class="n">eq2</span><span class="p">):</span>
    <span class="n">a1</span><span class="p">,</span> <span class="n">c1</span> <span class="o">=</span> <span class="n">eq1</span>
    <span class="n">a2</span><span class="p">,</span> <span class="n">c2</span> <span class="o">=</span> <span class="n">eq2</span>

    <span class="n">constant</span> <span class="o">=</span> <span class="n">c1</span> <span class="o">*</span> <span class="n">a2</span> <span class="o">-</span> <span class="n">c2</span> <span class="o">*</span> <span class="n">a1</span>

    <span class="k">return</span> <span class="n">constant</span> <span class="c1"># which is multiple of p
</span>
<span class="n">eq_1</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
    <span class="n">eq_1</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">point_to_eq</span><span class="p">(</span><span class="n">point</span><span class="p">))</span>

<span class="n">eq_3</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eq_1</span><span class="p">)):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">eq_1</span><span class="p">)):</span>
        <span class="n">eq_3</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">kill_b</span><span class="p">(</span><span class="n">eq_1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">eq_1</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>

<span class="n">p_multiple</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eq_3</span><span class="p">)):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">eq_3</span><span class="p">)):</span>
        <span class="n">p_multiple</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">kill_a</span><span class="p">(</span><span class="n">eq_3</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">eq_3</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">p_multiple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">p_multiple</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

<span class="n">nmul</span> <span class="o">=</span> <span class="mf">29408.</span><span class="p">..</span><span class="mi">7069</span>

<span class="n">t_3</span> <span class="o">=</span> <span class="n">enc_test</span>
<span class="n">negt</span> <span class="o">=</span> <span class="p">(</span><span class="n">ZZ</span><span class="p">(</span><span class="nb">int</span><span class="p">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="sa">b</span><span class="s">"ECRSA offers added security by elliptic entropy."</span><span class="p">,</span> <span class="s">'big'</span><span class="p">)),</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>

<span class="n">lamb</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">negt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">t_3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">negt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">lamb</span><span class="o">^</span><span class="mi">2</span> <span class="o">-</span> <span class="n">t_3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">negt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">lamb</span> <span class="o">*</span> <span class="p">(</span><span class="n">t_3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">t_3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">t_2</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="n">lamb</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">negt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">t_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">negt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">lamb</span><span class="o">^</span><span class="mi">2</span> <span class="o">-</span> <span class="n">t_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">negt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">lamb</span> <span class="o">*</span> <span class="p">(</span><span class="n">t_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">t_2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">t_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">%</span> <span class="n">nmul</span><span class="p">,</span> <span class="n">y</span> <span class="o">%</span> <span class="n">nmul</span><span class="p">)</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">148789535372424163728266646450060056789282887632409478972504939920226619164297864570138212065846604310648872389662317508759494232616904707691022520428483000923260778669946008689451863137527523684502948570798504215922534787506491833325381174139925947167122783344470619692746866285435276907642606269209931602317</span>

<span class="n">phi</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">d</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

<span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">enc_test</span>
<span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">enc_flag</span>

<span class="n">a</span> <span class="o">=</span> <span class="p">(((</span><span class="n">y1</span><span class="o">^</span><span class="mi">2</span> <span class="o">-</span> <span class="n">x1</span><span class="o">^</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">y2</span><span class="o">^</span><span class="mi">2</span> <span class="o">-</span> <span class="n">x2</span><span class="o">^</span><span class="mi">3</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span><span class="p">))</span> <span class="o">%</span> <span class="n">n</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">y1</span><span class="o">^</span><span class="mi">2</span> <span class="o">-</span> <span class="n">x1</span><span class="o">^</span><span class="mi">3</span> <span class="o">-</span> <span class="n">a</span> <span class="o">*</span> <span class="n">x1</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span>

<span class="n">E</span> <span class="o">=</span> <span class="n">EllipticCurve</span><span class="p">(</span><span class="n">Zmod</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>
<span class="n">eeeee_flag</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="n">enc_flag</span><span class="p">)</span>

<span class="n">add</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">phi</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">((</span><span class="n">add</span> <span class="o">-</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">add</span><span class="o">^</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">n</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">((</span><span class="n">add</span> <span class="o">+</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">add</span><span class="o">^</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">n</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">p</span> <span class="o">*</span> <span class="n">q</span> <span class="o">==</span> <span class="n">n</span>

<span class="n">Ep</span> <span class="o">=</span> <span class="n">EllipticCurve</span><span class="p">(</span><span class="n">Zmod</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>
<span class="n">Eq</span> <span class="o">=</span> <span class="n">EllipticCurve</span><span class="p">(</span><span class="n">Zmod</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>

<span class="n">f_p</span> <span class="o">=</span> <span class="n">Ep</span><span class="p">(</span><span class="n">enc_flag</span><span class="p">)</span>
<span class="n">f_q</span> <span class="o">=</span> <span class="n">Eq</span><span class="p">(</span><span class="n">enc_flag</span><span class="p">)</span>

<span class="n">test_p</span> <span class="o">=</span> <span class="n">Ep</span><span class="p">(</span><span class="n">enc_test</span><span class="p">)</span>
<span class="n">t_p</span> <span class="o">=</span> <span class="n">Ep</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">t_p</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">==</span> <span class="n">test_p</span>

<span class="n">ep_order</span> <span class="o">=</span> <span class="mi">12106285759457603837646209698473787447139576157605716627376889077738609086595367760906757844814552719704303248523074103662114018990337565151986764666812769</span>
<span class="n">eq_order</span> <span class="o">=</span> <span class="mi">12290271213546041363951851773787980582602437964255454723585180242187866091592930408418132906142473580819234492550892403489633401195027564397193372497063650</span>

<span class="n">flag_p</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">((</span><span class="n">f_p</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ep_order</span><span class="p">)).</span><span class="n">xy</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">flag_q</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">((</span><span class="n">f_q</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">eq_order</span><span class="p">)).</span><span class="n">xy</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">crt</span><span class="p">([</span><span class="n">flag_p</span><span class="p">,</span> <span class="n">flag_q</span><span class="p">],</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">])</span>

<span class="k">print</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</code></pre></div></div>

<p><br /><br /></p>

<h2 id="cleithrophobia-58-solves"><strong>Cleithrophobia (58 solves)</strong></h2>

<p>Easy symmetric cipher challenge with xoring blocks.</p>

<h3 id="cleithrophobiapy">cleithrophobia.py</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
#
# Polymero
#
</span>
<span class="c1"># Imports
</span><span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">from</span> <span class="nn">Crypto.Util.Padding</span> <span class="kn">import</span> <span class="n">pad</span><span class="p">,</span> <span class="n">unpad</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># Local imports
</span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'flag.txt'</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">FLAG</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># Header
</span><span class="n">HDR</span> <span class="o">=</span> <span class="sa">r</span><span class="s">"""|
|
|       __ _       ___ ____ ______ __ __ ____   ___  ____  __ __  ___  ____  ____  ____
|      /  ] |     /  _]    |      |  |  |    \ /   \|    \|  |  |/   \|    \|    |/    |
|     /  /| |    /  [_ |  ||      |  |  |  D  )     |  o  )  |  |     |  o  )|  ||  o  |
|    /  / | |___/    _]|  ||_|  |_|  _  |    /|  O  |   _/|  _  |  O  |     ||  ||     |
|   /   \_|     |   [_ |  |  |  | |  |  |    \|     |  |  |  |  |     |  O  ||  ||  _  |
|   \     |     |     ||  |  |  | |  |  |  .  \     |  |  |  |  |     |     ||  ||  |  |
|    \____|_____|_____|____| |__| |__|__|__|\_|\___/|__|  |__|__|\___/|_____|____|__|__|
|
|"""</span>

<span class="c1"># Server encryption function
</span><span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>

    <span class="n">pad_msg</span> <span class="o">=</span> <span class="n">pad</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
    <span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">16</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="n">pad_msg</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">16</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">pad_msg</span><span class="p">),</span><span class="mi">16</span><span class="p">)]</span>

    <span class="n">itm</span> <span class="o">=</span> <span class="p">[</span><span class="n">blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_ECB</span><span class="p">).</span><span class="n">encrypt</span><span class="p">(</span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">itm</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">bytes</span><span class="p">(</span><span class="n">j</span><span class="o">^</span><span class="n">k</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]))]</span>

    <span class="n">cip</span> <span class="o">=</span> <span class="p">[</span><span class="n">blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_ECB</span><span class="p">).</span><span class="n">decrypt</span><span class="p">(</span><span class="n">itm</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
        <span class="n">cip</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">bytes</span><span class="p">(</span><span class="n">j</span><span class="o">^</span><span class="n">k</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">itm</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="p">]))]</span>

    <span class="k">return</span> <span class="sa">b</span><span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">cip</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># Server connection
</span><span class="n">KEY</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">HDR</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"|  ~ I trapped the flag using AES encryption and decryption layers, so good luck ~ ^w^"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"|</span><span class="se">\n</span><span class="s">|    flag = </span><span class="si">{</span><span class="n">encrypt</span><span class="p">(</span><span class="n">FLAG</span><span class="p">,</span> <span class="n">KEY</span><span class="p">).</span><span class="nb">hex</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># Server loop
</span><span class="k">while</span> <span class="bp">True</span><span class="p">:</span>

    <span class="k">try</span><span class="p">:</span>

        <span class="k">print</span><span class="p">(</span><span class="s">"|</span><span class="se">\n</span><span class="s">|  ~ Want to encrypt something?"</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s">"|</span><span class="se">\n</span><span class="s">|    &gt; (hex) "</span><span class="p">))</span>

        <span class="n">enc</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">KEY</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"|</span><span class="se">\n</span><span class="s">|   </span><span class="si">{</span><span class="n">enc</span><span class="p">.</span><span class="nb">hex</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="nb">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">|</span><span class="se">\n</span><span class="s">|  ~ Well goodbye then ~</span><span class="se">\n</span><span class="s">|'</span><span class="p">)</span>
        <span class="k">break</span>

    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'|</span><span class="se">\n</span><span class="s">|  ~ Erhm... Are you okay?</span><span class="se">\n</span><span class="s">|'</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<p>The main idea is</p>

<p>We can both get the value for</p>

<p><code class="language-plaintext highlighter-rouge">dec(a ^ enc(b))</code> and <code class="language-plaintext highlighter-rouge">enc(c) ^ dec(a ^ enc(b))</code> so we can encrypt any block we want.</p>

<p>After knowing the encrypted block, decryption is easy too.</p>

<p><br /></p>

<h3 id="expy">ex.py</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"cleithrophobia.chal.idek.team"</span><span class="p">,</span> <span class="mi">1337</span><span class="p">)</span>

<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"flag = "</span><span class="p">)</span>

<span class="n">res</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">96</span> <span class="o">*</span> <span class="mi">2</span><span class="p">).</span><span class="n">decode</span><span class="p">())</span>
<span class="n">inv</span> <span class="o">=</span> <span class="sa">b</span><span class="s">""</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">//</span> <span class="mi">16</span><span class="p">):</span>
    <span class="n">inv</span> <span class="o">+=</span> <span class="n">res</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">16</span><span class="p">]</span>
<span class="n">enc_flag</span> <span class="o">=</span> <span class="n">inv</span>

<span class="c1"># print(len(enc_flag))
# 96 (6 blocks)
</span>
<span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"|    &gt; (hex) "</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">.</span><span class="nb">hex</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">()[</span><span class="mi">4</span><span class="p">:].</span><span class="n">decode</span><span class="p">())</span>

    <span class="n">inv</span> <span class="o">=</span> <span class="sa">b</span><span class="s">""</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">//</span> <span class="mi">16</span><span class="p">):</span>
        <span class="n">inv</span> <span class="o">+=</span> <span class="n">res</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">16</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">inv</span>

<span class="k">def</span> <span class="nf">enc</span><span class="p">(</span><span class="n">block</span><span class="p">):</span>
    <span class="n">b1</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x10</span><span class="s">"</span> <span class="o">*</span> <span class="mi">16</span>
    <span class="n">b2</span> <span class="o">=</span> <span class="n">block</span>
    <span class="n">b3</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x10</span><span class="s">"</span> <span class="o">*</span> <span class="mi">16</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span><span class="n">b1</span> <span class="o">+</span> <span class="n">b2</span><span class="p">)</span>
    <span class="n">b0</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">16</span><span class="p">]</span>
    <span class="n">b1_eb2_db0_eb1</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">48</span><span class="p">:</span><span class="mi">64</span><span class="p">]</span>

    <span class="n">res2</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span><span class="n">b1</span> <span class="o">+</span> <span class="n">b0</span><span class="p">)</span>
    <span class="n">db0_eb1</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">res2</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">16</span><span class="p">],</span> <span class="n">res2</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">32</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">xor</span><span class="p">(</span><span class="n">xor</span><span class="p">(</span><span class="n">b1_eb2_db0_eb1</span><span class="p">,</span> <span class="n">db0_eb1</span><span class="p">),</span> <span class="n">b1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">dec</span><span class="p">(</span><span class="n">block</span><span class="p">):</span>
    <span class="n">b2</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x10</span><span class="s">"</span> <span class="o">*</span> <span class="mi">16</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span><span class="n">xor</span><span class="p">(</span><span class="n">enc</span><span class="p">(</span><span class="n">b2</span><span class="p">),</span> <span class="n">block</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">xor</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">16</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">32</span><span class="p">])</span>

<span class="n">testblock</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"soon_haari_idiot"</span>
<span class="k">print</span><span class="p">(</span><span class="n">dec</span><span class="p">(</span><span class="n">enc</span><span class="p">(</span><span class="n">testblock</span><span class="p">)))</span>
<span class="k">print</span><span class="p">(</span><span class="n">enc</span><span class="p">(</span><span class="n">dec</span><span class="p">(</span><span class="n">testblock</span><span class="p">)))</span>

<span class="n">b0</span> <span class="o">=</span> <span class="n">enc_flag</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span>

<span class="n">itm</span> <span class="o">=</span> <span class="p">[</span><span class="n">b0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">itm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">enc</span><span class="p">(</span><span class="n">xor</span><span class="p">(</span><span class="n">itm</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">6</span><span class="p">],</span> <span class="n">enc_flag</span><span class="p">[</span><span class="mi">16</span> <span class="o">*</span> <span class="p">(</span><span class="mi">6</span> <span class="o">-</span> <span class="n">i</span><span class="p">):</span><span class="mi">16</span> <span class="o">*</span> <span class="p">(</span><span class="mi">7</span> <span class="o">-</span> <span class="n">i</span><span class="p">)]))</span>

<span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">b0</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">blocks</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">dec</span><span class="p">(</span><span class="n">xor</span><span class="p">(</span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">itm</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])))</span>

<span class="k">print</span><span class="p">(</span><span class="sa">b</span><span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">blocks</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>

<span class="n">r</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div>

<p><br /><br /></p>

<h2 id="primonumerophobia-10-solves"><strong>Primonumerophobia (10 solves)</strong></h2>

<h3 id="sourcepy">source.py</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">class</span> <span class="nc">LFSR</span><span class="p">():</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">taps</span><span class="p">):</span>

        <span class="n">d</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">taps</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">taps</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">-</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">taps</span><span class="p">]</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="p">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L</span><span class="p">):</span>

        <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">L</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">^=</span> <span class="n">t</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">_sum</span><span class="p">([</span><span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">taps</span><span class="p">])]</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">getPrime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbits</span><span class="p">):</span>

        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="nb">next</span><span class="p">())</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbits</span><span class="p">)]),</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">isPrime</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">nbits</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[LOG] It takes </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s"> trials to find a prime."</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">p</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>

    <span class="n">lfsr</span> <span class="o">=</span> <span class="n">LFSR</span><span class="p">([</span><span class="mi">47</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">p</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">lfsr</span><span class="p">.</span><span class="n">getPrime</span><span class="p">(</span><span class="mi">512</span><span class="p">),</span> <span class="n">lfsr</span><span class="p">.</span><span class="n">getPrime</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"flag.txt"</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"n = </span><span class="si">{</span><span class="n">p</span><span class="o">*</span><span class="n">q</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"enc = </span><span class="si">{</span><span class="nb">pow</span><span class="p">(</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="mh">0x10001</span><span class="p">,</span> <span class="n">p</span><span class="o">*</span><span class="n">q</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p>It use LSFR to generate prime numbers, and we know how far the two prime numbers are in LFSR.</p>

<p>So theoretically we can set 47 variables with only 0 and 1, and form all bits of p and q with those 47 variables’ addition mod 2.</p>

<p><br /></p>

<p>The main idea is we know the value for p * q, so if we know last 24 bits of p, we can find q’s last 24 bits of q by n / p (mod 2^24).</p>

<p>So we don’t need 47 bit brute-force, we only need 24 bit brute-force to solve this.</p>

<p>I commented most of the codes, because running single steps took long, so I copiedd the needed values and pasted in the code.</p>

<h3 id="exsage-1">ex.sage</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>

<span class="s">'''
add = [47, 43, 41, 37, 31, 29, 23, 19, 17, 13, 11, 7, 5, 3, 2]

arr = []
for i in range(47):
    line = [0] * 47
    line[i] = 1
    arr.append(line)

for i in range(47, 512 * (447 + 1)):
    line = [0] * 47
    for j in add:
        for k in range(47):
            line[k] += arr[i - j][k]
            line[k] %= 2
    arr.append(line)
    print(i)

assert len(arr) == 512 * (447 + 1)

print(arr[:512])
print(arr[-512:])
'''</span>

<span class="s">'''
p = {redacted}
q = {redacted}
assert len(p) == 512 and len(q) == 512
n = 78189483779073760819769596415493404181115737255987326126790953924148600157623709942134043192581448967829591214999561812461790206591977861764710056434977125005626712442593271233036617073503751799983263888626278748439349756982639988997517983470845431197233107232933125334078771472039280629203017666578936360521
enc = 39952631182502523101053953538875437560829302998610236142339435591980522271590392249355510253125310494063081880512061476177621613835835483055753316172267380484804011034657479491794064534740537749793563744927827732170347495398050941609682485707331552759412916426691849669362897656967530464847648838434750188588

mat = []
#mat.append(p[0])
for i in range(24):
    mat.append(p[511 - i])
for i in range(23):
    mat.append(q[511 - i])
mat = matrix(IntegerModRing(2), mat)
inv = mat.inverse()

P = 0
Q = 0

get_p_vec = [0] * 47

for i in range(512):
    for j in range(47):
        get_p_vec[j] += (1 &lt;&lt; (511 - i)) * p[i][j]

for k in range(1 &lt;&lt; 24):
    if k % 2 == 0:
        continue
    mod = 1 &lt;&lt; 23
    p_ = k
    q_ = (n * pow(p_, -1, mod)) % mod

    res = []
    for i in range(24):
        if p_ &amp; (1 &lt;&lt; i) &gt; 0:
            res.append([1])
        else:
            res.append([0])
    for i in range(23):
        if q_ &amp; (1 &lt;&lt; i) &gt; 0:
            res.append([1])
        else:
            res.append([0])
    res = matrix(IntegerModRing(2), res)
    vals = inv * res

    p_val = 0

    for i in range(47):
        p_val ^^= get_p_vec[i] * int(vals[i, 0])

    assert p_val % mod == p_

    if n % p_val == 0:
        P = p_val
        Q = n // P
        break

    print(k)

print(P)
'''</span>

<span class="n">p</span> <span class="o">=</span> <span class="mi">8148641146281585626599965707019875487540363795516672614500530970713004312213378852992447549855928600229171345524388095399807768385341698813126095446000969</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">78189483779073760819769596415493404181115737255987326126790953924148600157623709942134043192581448967829591214999561812461790206591977861764710056434977125005626712442593271233036617073503751799983263888626278748439349756982639988997517983470845431197233107232933125334078771472039280629203017666578936360521</span>
<span class="n">enc</span> <span class="o">=</span> <span class="mi">39952631182502523101053953538875437560829302998610236142339435591980522271590392249355510253125310494063081880512061476177621613835835483055753316172267380484804011034657479491794064534740537749793563744927827732170347495398050941609682485707331552759412916426691849669362897656967530464847648838434750188588</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">n</span> <span class="o">//</span> <span class="n">p</span>
<span class="k">assert</span> <span class="n">p</span> <span class="o">*</span> <span class="n">q</span> <span class="o">==</span> <span class="n">n</span>

<span class="n">d</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="mh">0x10001</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

<span class="k">print</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">enc</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">n</span><span class="p">)))</span>
</code></pre></div></div>

<p><br /><br /></p>

<h2 id="psychophobia-11-solves">Psychophobia (11 solves)</h2>

<p>This is a challenge that uses inverse function’s action when gcd of two values isn’t 1.</p>

<p>(That’s why I always use <code class="language-plaintext highlighter-rouge">pow(val, -1, mod)</code>.)</p>

<h3 id="psychophobiapy">psychophobia.py</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
#
# Polymero
#
</span>
<span class="c1"># Imports
</span><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">inverse</span>
<span class="kn">from</span> <span class="nn">secrets</span> <span class="kn">import</span> <span class="n">randbelow</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha256</span>

<span class="c1"># Local imports
</span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'flag.txt'</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">FLAG</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># Header
</span><span class="n">HDR</span> <span class="o">=</span> <span class="sa">r</span><span class="s">"""|
|                                _           ___
|                               | |         / _ \
|    _  _  _ _   ___   _____   _| |_   ___ | |_) )_  __  __
|   | || || | | | \ \ / / _ \ /     \ / _ \|  _ &lt;| |/  \/ /
|   | \| |/ | |_| |\ v ( (_) | (| |) | (_) ) |_) ) ( ()  &lt;
|    \_   _/ \___/  &gt; &lt; \___/ \_   _/ \___/|  __/ \_)__/\_\
|      | |         / ^ \        | |        | |
|      |_|        /_/ \_\       |_|        |_|
|
|"""</span>

<span class="c1"># Curve 25519 :: By^2 = x^3 + Ax^2 + x  mod P
# https://en.wikipedia.org/wiki/Curve25519
# Curve Parameters
</span><span class="n">P</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">255</span> <span class="o">-</span> <span class="mi">19</span>
<span class="n">A</span> <span class="o">=</span> <span class="mi">486662</span>
<span class="n">B</span> <span class="o">=</span> <span class="mi">1</span>
<span class="c1"># Order of the Curve
</span><span class="n">O</span> <span class="o">=</span> <span class="mi">57896044618658097711785492504343953926856930875039260848015607506283634007912</span>

<span class="c1"># ECC Class
</span><span class="k">class</span> <span class="nc">Point</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">is_on_curve</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">"Point NOT on Curve 25519!"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_on_curve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">y</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="p">.</span><span class="n">x</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="n">A</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">%</span> <span class="n">P</span><span class="p">)</span> <span class="o">==</span> <span class="p">((</span><span class="n">B</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="n">P</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">lift_x</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">y_sqr</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="n">A</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">inverse</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">P</span><span class="p">))</span> <span class="o">%</span> <span class="n">P</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">y_sqr</span><span class="p">,</span> <span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">//</span> <span class="mi">8</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">y_sqr</span> <span class="o">*</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="n">P</span>
        <span class="k">return</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">y_sqr</span> <span class="o">*</span> <span class="n">v</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">i</span><span class="p">))</span> <span class="o">%</span> <span class="n">P</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">"Point ({}, {}) on Curve 25519"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">y</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">x</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">x</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">y</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">y</span>

    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span> <span class="o">==</span> <span class="bp">self</span><span class="p">.</span><span class="n">__class__</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">other</span>
        <span class="k">if</span> <span class="n">other</span> <span class="o">==</span> <span class="bp">self</span><span class="p">.</span><span class="n">__class__</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">x</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">x</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">y</span> <span class="o">!=</span> <span class="n">other</span><span class="p">.</span><span class="n">y</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__class__</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">x</span> <span class="o">!=</span> <span class="n">other</span><span class="p">.</span><span class="n">x</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="p">((</span><span class="n">other</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">inverse</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">P</span><span class="p">))</span> <span class="o">%</span> <span class="n">P</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="p">((</span><span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">A</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">inverse</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">P</span><span class="p">))</span> <span class="o">%</span> <span class="n">P</span>

        <span class="n">x3</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">A</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">other</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">%</span> <span class="n">P</span>
        <span class="n">y3</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">x3</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">%</span> <span class="n">P</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">__class__</span><span class="p">(</span><span class="n">x3</span><span class="p">,</span> <span class="n">y3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__rmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">__class__</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">__class__</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">y</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">k</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">tmp</span>
            <span class="n">tmp</span> <span class="o">+=</span> <span class="n">tmp</span>
            <span class="n">k</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="c1"># Curve25519 Base Point
</span><span class="n">G</span> <span class="o">=</span> <span class="n">Point</span><span class="p">.</span><span class="n">lift_x</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>

<span class="c1"># ECDSA Functions
# https://en.wikipedia.org/wiki/Elliptic_Curve_Digital_Signature_Algorithm
</span><span class="k">def</span> <span class="nf">ECDSA_sign</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">priv</span><span class="p">):</span>
    <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">sha256</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">encode</span><span class="p">()).</span><span class="n">digest</span><span class="p">(),</span> <span class="s">'big'</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">h</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">priv</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">randbelow</span><span class="p">(</span><span class="n">O</span><span class="p">))</span> <span class="o">%</span> <span class="n">O</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">G</span><span class="p">).</span><span class="n">x</span> <span class="o">%</span> <span class="n">O</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">inverse</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">O</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="n">priv</span><span class="p">))</span> <span class="o">%</span> <span class="n">O</span>

    <span class="k">if</span> <span class="n">r</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">s</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">inverse</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">O</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="n">k</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ECDSA_verify</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">pub</span><span class="p">,</span> <span class="n">sig</span><span class="p">):</span>
    <span class="n">r</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">sig</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">O</span> <span class="ow">and</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">O</span><span class="p">:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">sha256</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">encode</span><span class="p">()).</span><span class="n">digest</span><span class="p">(),</span> <span class="s">'big'</span><span class="p">)</span>
        <span class="n">u1</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">inverse</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">O</span><span class="p">))</span> <span class="o">%</span> <span class="n">O</span>
        <span class="n">u2</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">inverse</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">O</span><span class="p">))</span> <span class="o">%</span> <span class="n">O</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="p">(</span><span class="n">u1</span> <span class="o">*</span> <span class="n">G</span> <span class="o">+</span> <span class="n">u2</span> <span class="o">*</span> <span class="n">pub</span><span class="p">).</span><span class="n">x</span> <span class="o">%</span> <span class="n">O</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>

<span class="c1"># Server connection
</span><span class="k">print</span><span class="p">(</span><span class="n">HDR</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"|</span><span class="se">\n</span><span class="s">|  ~ Are you the psychic I requested? What can I call you?"</span><span class="p">)</span>
<span class="n">name</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s">"|    &gt; "</span><span class="p">)</span>

<span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s"> here, requesting flag for pick-up."</span>
<span class="k">print</span><span class="p">(</span><span class="s">'|</span><span class="se">\n</span><span class="s">|  ~ Alright, here is the message I will sign for you :: '</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'|    m = </span><span class="se">\"</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="se">\"</span><span class="s">'</span><span class="p">)</span>

<span class="n">ITER</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">RATE</span> <span class="o">=</span> <span class="mf">0.72</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'|</span><span class="se">\n</span><span class="s">|  ~ The following </span><span class="si">{</span><span class="n">ITER</span><span class="si">}</span><span class="s"> signatures are all broken, please fix them for me to prove your psychic abilities ~'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'|    If you get more than, say, </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">RATE</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s">% correct, I will believe you ^w^'</span><span class="p">)</span>

<span class="c1"># Server loop
</span><span class="n">success</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ITER</span><span class="p">):</span>

    <span class="k">try</span><span class="p">:</span>

        <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">randbelow</span><span class="p">(</span><span class="n">O</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">O</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">G</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">ECDSA_sign</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ECDSA_verify</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">sig</span><span class="p">):</span>
                <span class="k">break</span>

        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"|</span><span class="se">\n</span><span class="s">|  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s">. Please fix :: </span><span class="si">{</span><span class="n">sig</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

        <span class="n">fix</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">(</span><span class="s">"|    &gt; (r,s) "</span><span class="p">).</span><span class="n">split</span><span class="p">(</span><span class="s">','</span><span class="p">)]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">fix</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="n">ECDSA_verify</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">fix</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"nice!"</span><span class="p">)</span>
            <span class="n">success</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"fuck you"</span><span class="p">)</span> <span class="c1"># I added this part to check locally..
</span>
    <span class="k">except</span> <span class="nb">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">|'</span><span class="p">)</span>
        <span class="k">break</span>

    <span class="k">except</span><span class="p">:</span>
        <span class="k">continue</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"|</span><span class="se">\n</span><span class="s">|  ~ You managed to fix a total of </span><span class="si">{</span><span class="n">success</span><span class="si">}</span><span class="s"> signatures!"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">success</span> <span class="o">/</span> <span class="n">ITER</span> <span class="o">&gt;</span> <span class="n">RATE</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"|</span><span class="se">\n</span><span class="s">|  ~ You truly are psychic, here </span><span class="si">{</span><span class="n">FLAG</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"|</span><span class="se">\n</span><span class="s">|  ~ Seems like you are a fraud after all..."</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">'|</span><span class="se">\n</span><span class="s">|'</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<p>The challenge uses curve25519 for Elliptic Curve.</p>

<p><br /></p>

<p>I did some search on it, and found that the order of the curve is 8 * (prime number).</p>

<p>Let’s call it <code class="language-plaintext highlighter-rouge">Order = 8 * o</code>.</p>

<p>And in the sign function, it’s setting k as multiple of 4.</p>

<p>Which will make multiple of 8, and multiple of 4 but not 8.</p>

<p><br /></p>

<p>If we find the implementation for the inverse function, it looks like this:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">inverse</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
    <span class="s">"""inverse(u:long, v:long):long
    Return the inverse of u mod v.
    """</span>
    <span class="n">u3</span><span class="p">,</span> <span class="n">v3</span> <span class="o">=</span> <span class="nb">long</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="nb">long</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">u1</span><span class="p">,</span> <span class="n">v1</span> <span class="o">=</span> <span class="il">1L</span><span class="p">,</span> <span class="il">0L</span>
    <span class="k">while</span> <span class="n">v3</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">q</span><span class="o">=</span><span class="nb">divmod</span><span class="p">(</span><span class="n">u3</span><span class="p">,</span> <span class="n">v3</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">u1</span><span class="p">,</span> <span class="n">v1</span> <span class="o">=</span> <span class="n">v1</span><span class="p">,</span> <span class="n">u1</span> <span class="o">-</span> <span class="n">v1</span><span class="o">*</span><span class="n">q</span>
        <span class="n">u3</span><span class="p">,</span> <span class="n">v3</span> <span class="o">=</span> <span class="n">v3</span><span class="p">,</span> <span class="n">u3</span> <span class="o">-</span> <span class="n">v3</span><span class="o">*</span><span class="n">q</span>
    <span class="k">while</span> <span class="n">u1</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">u1</span> <span class="o">=</span> <span class="n">u1</span> <span class="o">+</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">u1</span>
</code></pre></div></div>

<p><br /></p>

<p>Without the last while loop,</p>

<p>we know <code class="language-plaintext highlighter-rouge">inverse(v, m) == inverse(v // gcd(v, m), m // gcd(v, m))</code></p>

<p>So let’s observe the <code class="language-plaintext highlighter-rouge">inverse(k, O)</code> value which is in s.</p>

<p>It can be written to <code class="language-plaintext highlighter-rouge">inverse(k, 8 * o)</code>.</p>

<p><br /></p>

<p>If k is multiple of 4, but not 8, let’s write <code class="language-plaintext highlighter-rouge">k = 4 * k0</code>, k0 is odd.</p>

<p>Then we know <code class="language-plaintext highlighter-rouge">inverse(k, O) == inverse(k0, 2 * o)</code> without last while loop.</p>

<p>But in this case, while loop only adds 8 * o or 2 * o, so in conclusion</p>

<p>We can say <code class="language-plaintext highlighter-rouge">inverse(k, O) == inverse(k0, 2 * o) (mod 2 * o)</code>.</p>

<p>(Important, this can say <code class="language-plaintext highlighter-rouge">inverse(k, O)</code> is always odd.)</p>

<p><br /></p>

<p>So, <code class="language-plaintext highlighter-rouge">inverse(k, O) == inverse(k // 4, O) (mod o)</code>.</p>

<p>Our goal is to divide the s value by 4 in this case.</p>

<p>(And make sure if the sending s is even, add p to make it odd, so that inverse function in verify won’t give any exceptions.)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">send</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span> <span class="o">%</span> <span class="n">p</span>
        <span class="k">if</span> <span class="n">send</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">send</span> <span class="o">+=</span> <span class="n">p</span>
        <span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt; (r,s) "</span><span class="p">,</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">send</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p>In the same way, if k is multiple of 8, our goal is to divide s by 8.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">send</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span> <span class="o">%</span> <span class="n">p</span>
            <span class="k">if</span> <span class="n">send</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">send</span> <span class="o">+=</span> <span class="n">p</span>
            <span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt; (r,s) "</span><span class="p">,</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">send</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p>The verifying is only consistent to p, not 8, because the curve’s base point is multiple of 8 already, so the order is o, not 8 * o.</p>

<p>Now we have to know if its multiple of 8, or multiple of 4 by over 72% accuracy.</p>

<p><br /></p>

<p>We have some clues to do that.</p>

<p>r should be 50% even and 50% odd,</p>

<p>and s is defined this way,</p>

<p><code class="language-plaintext highlighter-rouge">s = (inverse(k, O) * (h + r * priv)) % O</code></p>

<p><br /></p>

<p>If we know inverse(k, O) is even, we know that k is mutiple of 8.</p>

<p>Because as I said earlier, if k is multiple of 4, inverse(k, O) is always odd.</p>

<p>So we can count how many 2s are multiplied to (h + r*priv) and s.</p>

<p>If s has more 2, k is multiple of 8.</p>

<p><br /></p>

<p>Now comes the trick. The chall said priv is odd, and h can be setted by ourselves.</p>

<p>So let’s find a h which is multiple of 8.</p>

<p>Then 2s contained in (h + r*priv) and r are the same.</p>

<p>Since we know both r and s, we can calculate this.</p>

<p>When r has more than s, or the same, we assume that k is multiple of 4.</p>

<p>When we run this with simple algorithm. It gives more accuracy than 72% more than 50% probability.</p>

<h3 id="exsage-2">ex.sage</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha256</span>

<span class="n">p</span> <span class="o">=</span> <span class="mi">2</span><span class="o">^</span><span class="mi">252</span> <span class="o">+</span> <span class="mi">27742317777372353535851937790883648493</span>
<span class="n">O</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="mi">8</span>

<span class="c1">#io = process(["python3", "psychophobia.py"])
</span><span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"psychophobia.chal.idek.team"</span><span class="p">,</span> <span class="mi">1337</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">count2</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="mi">3</span>

<span class="n">name</span> <span class="o">=</span> <span class="s">""</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s"> here, requesting flag for pick-up."</span>
    <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">sha256</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">encode</span><span class="p">()).</span><span class="n">digest</span><span class="p">(),</span> <span class="s">'big'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">h</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">break</span>

<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"  ~ Are you the psychic I requested? What can I call you?</span><span class="se">\n</span><span class="s">|    &gt; "</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">500</span><span class="p">):</span>
    <span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Please fix :: ("</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">", "</span><span class="p">)[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">")"</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">r</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">s</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">send</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span> <span class="o">%</span> <span class="n">p</span>
        <span class="k">if</span> <span class="n">send</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">send</span> <span class="o">+=</span> <span class="n">p</span>
        <span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt; (r,s) "</span><span class="p">,</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">send</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">r</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">s</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">send</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span> <span class="o">%</span> <span class="n">p</span>
        <span class="k">if</span> <span class="n">send</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">send</span> <span class="o">+=</span> <span class="n">p</span>
        <span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt; (r,s) "</span><span class="p">,</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">send</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rcount</span> <span class="o">=</span> <span class="n">count2</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">scount</span> <span class="o">=</span> <span class="n">count2</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scount</span> <span class="o">&gt;</span> <span class="n">rcount</span><span class="p">:</span>
            <span class="n">send</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span> <span class="o">%</span> <span class="n">p</span>
            <span class="k">if</span> <span class="n">send</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">send</span> <span class="o">+=</span> <span class="n">p</span>
            <span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt; (r,s) "</span><span class="p">,</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">send</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">send</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span> <span class="o">%</span> <span class="n">p</span>
            <span class="k">if</span> <span class="n">send</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">send</span> <span class="o">+=</span> <span class="n">p</span>
            <span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt; (r,s) "</span><span class="p">,</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">send</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="n">io</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div>

<p><br /><br /></p>

<h2 id="unsolved---formal-security-poop-6-solves">Unsolved - Formal Security Poop (6 solves)</h2>

<p>During the CTF, I knew the challenge’s vulnerabilty was that it doesn’t check if the point is on the curve. But till I heard the solution after the CTF ended, I have never heard about <code class="language-plaintext highlighter-rouge">invalid curve attack</code>(wish there is a challenge about this on cryptohack), so I couldn’t solve it during it. Next time when this attack appears, I wish I can solve it.</p>

<h3 id="mainpy">main.py</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Crypto.Util.Padding</span> <span class="kn">import</span> <span class="n">pad</span><span class="p">,</span> <span class="n">unpad</span>
<span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">from</span> <span class="nn">ecc</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">class</span> <span class="nc">Vault</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">secrets</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">owner</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c1"># Please see https://en.wikipedia.org/wiki/Proof_of_knowledge#Schnorr_protocol for how to interact
</span>        <span class="c1"># But we do it over ellipthicc curves, because we already have a group setup :D
</span>        <span class="n">P</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">secrets</span><span class="p">[</span><span class="n">owner</span><span class="p">]</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Please prove that you are </span><span class="si">{</span><span class="n">owner</span><span class="si">}</span><span class="s">:"</span><span class="p">)</span>

        <span class="n">T</span> <span class="o">=</span> <span class="n">Point</span><span class="p">.</span><span class="nb">input</span><span class="p">(</span><span class="s">"Give me the point T: "</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'c ='</span><span class="p">,</span> <span class="n">c</span> <span class="p">:</span><span class="o">=</span> <span class="n">randbelow</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
        <span class="n">s</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s">'s = '</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">s</span><span class="o">*</span><span class="n">G</span> <span class="o">==</span> <span class="n">T</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="n">P</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Successfully authenticated!"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Who are you?? Go away!"</span><span class="p">)</span>
            <span class="nb">exit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">owner</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">secret</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">secrets</span><span class="p">[</span><span class="n">owner</span><span class="p">]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">int</span><span class="p">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">sha512</span><span class="p">(</span><span class="n">secret</span><span class="p">).</span><span class="n">digest</span><span class="p">(),</span> <span class="s">'big'</span><span class="p">)</span> <span class="o">%</span> <span class="n">p</span>

        <span class="n">k</span> <span class="o">=</span> <span class="n">randbelow</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">64</span><span class="p">)</span> <span class="c1"># [Note to self: make the bound dynamic on Y's order]
</span>        <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">G</span><span class="p">).</span><span class="n">x</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="n">r</span><span class="o">*</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="nb">pow</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">%</span> <span class="n">p</span>
        <span class="c1"># Verify the signature with (r, _) == (1/s)*(m*G + r*Y)
</span>        <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">secret</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">owner</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">P</span><span class="p">:</span> <span class="n">Point</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">owner</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">secrets</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">secrets</span><span class="p">[</span><span class="n">owner</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span><span class="p">,</span> <span class="n">secret</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">owner</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">secrets</span><span class="p">[</span><span class="n">owner</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span><span class="p">,</span> <span class="n">secret</span>

    <span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">owner</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">secret</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">secrets</span><span class="p">[</span><span class="n">owner</span><span class="p">]</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">owner</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">secret</span>

<span class="k">def</span> <span class="nf">session</span><span class="p">():</span>
    <span class="c1"># x, X = gen_key(): your ephemeral keypair
</span>    <span class="n">X</span> <span class="o">=</span> <span class="n">Point</span><span class="p">.</span><span class="nb">input</span><span class="p">(</span><span class="s">"What is your ephemeral key?"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">X</span> <span class="o">!=</span> <span class="n">E</span><span class="p">.</span><span class="n">O</span>

    <span class="n">y</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">gen_key</span><span class="p">()</span>
    <span class="n">B</span><span class="p">.</span><span class="k">print</span><span class="p">(</span><span class="s">"Here is my public key:"</span><span class="p">)</span>
    <span class="n">Y</span><span class="p">.</span><span class="k">print</span><span class="p">(</span><span class="s">"Here is my ephemeral key:"</span><span class="p">)</span>

    <span class="n">S</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">H</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">*</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">X</span> <span class="o">+</span> <span class="n">H</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">)</span> <span class="c1"># Shared knowledge
</span>    <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">sha512</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="n">S</span><span class="p">).</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s">'big'</span><span class="p">)).</span><span class="n">digest</span><span class="p">()[:</span><span class="mi">16</span><span class="p">]</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'flag.txt'</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>

    <span class="c1"># a, A = gen_key(): your long term keypair
</span>    <span class="n">A</span> <span class="o">=</span> <span class="n">Point</span><span class="p">.</span><span class="nb">input</span><span class="p">(</span><span class="s">"What is your public key?"</span><span class="p">)</span>
    <span class="n">b</span><span class="p">,</span> <span class="n">B</span> <span class="o">=</span> <span class="n">gen_key</span><span class="p">()</span>
    <span class="n">y</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">session</span><span class="p">()</span>
    <span class="c1"># Communication is encrypted so that third parties can't steal your secrets!
</span>    <span class="n">aes</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_ECB</span><span class="p">)</span>
    <span class="c1">#print(key)
</span>
    <span class="n">vault</span> <span class="o">=</span> <span class="n">Vault</span><span class="p">()</span>
    <span class="n">vault</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="s">'Bob'</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="n">vault</span><span class="p">.</span><span class="n">secrets</span><span class="p">)</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"""
[1] Store a secret
[2] Retrieve a secret
[3] Sign a secret
[4] Reinitialize session
        """</span><span class="p">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s">'&gt;&gt;&gt; '</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">owner</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s">"Who are you? "</span><span class="p">)</span>
            <span class="n">secret</span> <span class="o">=</span> <span class="n">aes</span><span class="p">.</span><span class="n">decrypt</span><span class="p">(</span><span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s">'secret = '</span><span class="p">)))</span>
            <span class="n">vault</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="n">unpad</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="n">owner</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Secret successfully stored!"</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">owner</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s">"Who are you? "</span><span class="p">)</span>
            <span class="n">secret</span> <span class="o">=</span> <span class="n">pad</span><span class="p">(</span><span class="n">vault</span><span class="p">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">owner</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Here is your secret:"</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'secret ='</span><span class="p">,</span> <span class="n">aes</span><span class="p">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">secret</span><span class="p">).</span><span class="nb">hex</span><span class="p">())</span>

        <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">owner</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s">"Whose secret should I sign? "</span><span class="p">)</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">vault</span><span class="p">.</span><span class="n">sign</span><span class="p">(</span><span class="n">owner</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Here is the signature:"</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'r ='</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'s ='</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">y</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">session</span><span class="p">()</span>
            <span class="n">aes</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_ECB</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"My secrets are safe forever!"</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="nb">exit</span><span class="p">()</span>
</code></pre></div></div>

<p>I will skip the <code class="language-plaintext highlighter-rouge">ecc.py</code>. It is a file implementing elliptic curve for secp128r1, but without checking if a point is on the curve.</p>

<p>The basic idea for this chall is using this info of S:</p>

<center>$S = (y + H(Y)*b)*(X + H(X)*A)$</center>

<p>When we set $A$ to 0, and $X$ to a point(doesn’t have to be on secp128r1) with low order, we can get the value for $y + H(Y)*b$ with discrete_log. If we get $y$ and $H(Y)$, we can get $b$ as remainder of $X$’s order as modulus.</p>

<p>This attack(Invalid curve attack) works because curve parameter b is never used during point addition or multiplication. So we can use any kind of curve with GF(p) and parameter a. Lots of order exist in that kind of code, and we can dig up some small prime orders, and use Pohlig-Hellman algorithm.</p>

<p><br /></p>

<p>To get value y from this chall, we have to use the sign function, which sets k to a small value under 2^64. <a href="https://eprint.iacr.org/2019/023.pdf">https://eprint.iacr.org/2019/023.pdf</a> this explains very well about this attack.</p>

<p>It was pretty surprising that eventually I have to use all the choices that exist to solve this.</p>

<p>I implemented getting small-ordered points by myself, and it wasn’t much different from the author’s.</p>

<h3 id="exsage-3">ex.sage</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">ecc</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">Crypto.Util.Padding</span> <span class="kn">import</span> <span class="n">pad</span><span class="p">,</span> <span class="n">unpad</span>
<span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>

<span class="c1">#io = process(["python3", "main.py"])
</span><span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"formal-security-poop.chal.idek.team"</span><span class="p">,</span> <span class="mi">1337</span><span class="p">)</span>

<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"x = "</span><span class="p">,</span> <span class="s">"0"</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"y = "</span><span class="p">,</span> <span class="s">"0"</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"x = "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">Gx</span><span class="p">))</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"y = "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">Gy</span><span class="p">))</span>

<span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"x = "</span><span class="p">)</span>
<span class="n">Bx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">())</span>
<span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"y = "</span><span class="p">)</span>
<span class="n">By</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">())</span>

<span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"x = "</span><span class="p">)</span>
<span class="n">Yx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">())</span>
<span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"y = "</span><span class="p">)</span>
<span class="n">Yy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">())</span>

<span class="n">A</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">Bx</span><span class="p">,</span> <span class="n">By</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">G</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">Yx</span><span class="p">,</span> <span class="n">Yy</span><span class="p">)</span>

<span class="n">S</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">+</span> <span class="n">H</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">*</span><span class="n">B</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">sha512</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="n">S</span><span class="p">).</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s">'big'</span><span class="p">)).</span><span class="n">digest</span><span class="p">()[:</span><span class="mi">16</span><span class="p">]</span>

<span class="n">secret</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"soon_haari_stupid_idiot_doesnt_know_invalid_curve_attack"</span>
<span class="n">name</span> <span class="o">=</span> <span class="s">"soon_haari"</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt;&gt;&gt; "</span><span class="p">,</span> <span class="s">"1"</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"Who are you? "</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

<span class="n">aes</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_ECB</span><span class="p">)</span>
<span class="n">send</span> <span class="o">=</span> <span class="n">aes</span><span class="p">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">pad</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"secret = "</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">.</span><span class="nb">hex</span><span class="p">(</span><span class="n">send</span><span class="p">))</span>

<span class="n">pairs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">prod</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">b_</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">E_</span> <span class="o">=</span> <span class="n">EllipticCurve</span><span class="p">(</span><span class="n">GF</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="p">[</span><span class="mh">0xfffffffdfffffffffffffffffffffffc</span><span class="p">,</span> <span class="n">b_</span><span class="p">])</span>

    <span class="n">factors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">E_</span><span class="p">.</span><span class="n">order</span><span class="p">().</span><span class="n">factor</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">factors</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="mi">10000</span> <span class="ow">or</span> <span class="n">a</span> <span class="o">&gt;=</span> <span class="mi">100000</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">prod</span> <span class="o">%</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">G_</span> <span class="o">=</span> <span class="n">E_</span><span class="p">.</span><span class="n">random_element</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="n">E_</span><span class="p">.</span><span class="n">order</span><span class="p">()</span> <span class="o">//</span> <span class="n">a</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">G_</span><span class="p">.</span><span class="n">order</span><span class="p">()</span> <span class="o">==</span> <span class="n">a</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="n">pairs</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">b_</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">G_</span><span class="p">))</span>
        <span class="n">prod</span> <span class="o">*=</span> <span class="n">a</span>

    <span class="k">if</span> <span class="n">prod</span> <span class="o">&gt;</span> <span class="n">p</span><span class="p">:</span>
        <span class="k">break</span>

<span class="c1">#print(pairs)
</span>
<span class="n">remain</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">modular</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Number of steps: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt;&gt;&gt; "</span><span class="p">,</span> <span class="s">"4"</span><span class="p">)</span>

        <span class="n">b_</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">G_</span> <span class="o">=</span> <span class="n">pair</span>
        <span class="n">G_</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">G_</span><span class="p">.</span><span class="n">xy</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">G_</span><span class="p">.</span><span class="n">xy</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"x = "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">G_</span><span class="p">.</span><span class="n">x</span><span class="p">))</span>
        <span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"y = "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">G_</span><span class="p">.</span><span class="n">y</span><span class="p">))</span>

        <span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"x = "</span><span class="p">)</span>
        <span class="n">Bx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">())</span>
        <span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"y = "</span><span class="p">)</span>
        <span class="n">By</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">())</span>

        <span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"x = "</span><span class="p">)</span>
        <span class="n">Yx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">())</span>
        <span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"y = "</span><span class="p">)</span>
        <span class="n">Yy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">())</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">Yx</span><span class="p">,</span> <span class="n">Yy</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">H</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">%</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="n">num_data</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">int</span><span class="p">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">sha512</span><span class="p">(</span><span class="n">secret</span><span class="p">).</span><span class="n">digest</span><span class="p">(),</span> <span class="s">'big'</span><span class="p">)</span> <span class="o">%</span> <span class="n">p</span>
    <span class="n">t_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">a_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">B_</span> <span class="o">=</span> <span class="mi">2</span><span class="o">^</span><span class="mi">64</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_data</span><span class="p">):</span>
        <span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt;&gt;&gt; "</span><span class="p">,</span> <span class="s">"3"</span><span class="p">)</span>
        <span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"Whose secret should I sign? "</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"r = "</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">()))</span>
        <span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"s = "</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">()))</span>

        <span class="n">t_list</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">r</span> <span class="o">/</span> <span class="n">s</span><span class="p">)</span> <span class="o">%</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">a_list</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="o">-</span><span class="n">m</span> <span class="o">/</span> <span class="n">s</span><span class="p">)</span> <span class="o">%</span> <span class="n">p</span><span class="p">)</span>

    <span class="n">mat</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_data</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_data</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
        <span class="n">mat</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">t_list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">B_</span> <span class="o">/</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">t_list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">a_list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">a_list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">B_</span><span class="p">)</span>
    <span class="n">mat</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">t_list</span><span class="p">)</span>
    <span class="n">mat</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_list</span><span class="p">)</span>

    <span class="n">mat</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">(</span><span class="n">mat</span><span class="p">).</span><span class="n">LLL</span><span class="p">()</span>

    <span class="n">ks</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">k</span> <span class="o">=</span> <span class="o">-</span><span class="n">ks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">((</span><span class="n">k</span> <span class="o">+</span> <span class="n">a_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">t_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">%</span> <span class="n">p</span>

    <span class="k">assert</span> <span class="n">G</span> <span class="o">*</span> <span class="n">y</span> <span class="o">==</span> <span class="n">Y</span>


    <span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt;&gt;&gt; "</span><span class="p">,</span> <span class="s">"2"</span><span class="p">)</span>
    <span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"Who are you? "</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"x = "</span><span class="p">,</span> <span class="s">"0"</span><span class="p">)</span>
    <span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"y = "</span><span class="p">,</span> <span class="s">"0"</span><span class="p">)</span>
    <span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"s = "</span><span class="p">,</span> <span class="s">"0"</span><span class="p">)</span>

    <span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"secret = "</span><span class="p">)</span>
    <span class="n">enc</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">decode</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">enc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">64</span>

    <span class="n">S</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">S</span><span class="p">.</span><span class="n">x</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">S</span><span class="p">.</span><span class="n">y</span><span class="p">))</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">sha512</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="n">S</span><span class="p">).</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s">'big'</span><span class="p">)).</span><span class="n">digest</span><span class="p">()[:</span><span class="mi">16</span><span class="p">]</span>
        <span class="n">aes</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_ECB</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">aes</span><span class="p">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">pad</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span> <span class="o">==</span> <span class="n">enc</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">i</span> <span class="o">*</span> <span class="n">G_</span> <span class="o">==</span> <span class="n">S</span>
            <span class="n">b_remain</span> <span class="o">=</span> <span class="p">((</span><span class="n">i</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="n">H</span><span class="p">(</span><span class="n">Y</span><span class="p">))</span> <span class="o">%</span> <span class="n">a</span>
            <span class="n">remain</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">b_remain</span><span class="p">)</span>
            <span class="n">modular</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

            <span class="k">print</span><span class="p">(</span><span class="n">b_remain</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>

            <span class="k">break</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">S</span> <span class="o">+</span> <span class="n">G_</span>

<span class="n">b</span> <span class="o">=</span> <span class="n">crt</span><span class="p">(</span><span class="n">remain</span><span class="p">,</span> <span class="n">modular</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">b</span> <span class="o">*</span> <span class="n">G</span> <span class="o">==</span> <span class="n">B</span>

<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt;&gt;&gt; "</span><span class="p">,</span> <span class="s">"2"</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"Who are you? "</span><span class="p">,</span> <span class="s">"Bob"</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"x = "</span><span class="p">,</span> <span class="s">"0"</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"y = "</span><span class="p">,</span> <span class="s">"0"</span><span class="p">)</span>

<span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"c = "</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">()))</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"s = "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="n">b</span><span class="p">))</span>

<span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"secret = "</span><span class="p">)</span>
<span class="n">secret</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">decode</span><span class="p">())</span>

<span class="n">flag</span> <span class="o">=</span> <span class="n">unpad</span><span class="p">(</span><span class="n">aes</span><span class="p">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">secret</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>

<span class="n">io</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div>

</article>


      </div>
    </main>
  </body>
</html>